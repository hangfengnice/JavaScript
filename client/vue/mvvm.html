<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
</head>
<body>
  <div id="app">
    <form action="">
      <input type="text" v-model='number'>
      
      <h3 v-bind='number'></h3>
    </form>
    <button v-click='increment'>增加</button>
  </div>
  <script>
    
    function MyVue(options) {
      this._init(options)
    }
    MyVue.prototype._init = function (options) {
      this.$options = options
      this.$el = document.querySelector(options.el)
      this.$data = options.data
      this.$methods = options.methods
      this._binding = {}
      this._obverse(this.$data)
      this._complie(this.$el)
    }
    MyVue.prototype._obverse = function (obj) {
      let _this = this
      console.log(this)
      let value
      for (key in obj) {
        if (obj.hasOwnProperty(key)) {
          _this._binding[key] = {
            _directives: []
          }
          value = obj[key]
          if (typeof value === 'object') {
            _this._obverse(value)
          }
          let binding = _this._binding[key]
          Object.defineProperty(_this.$data, key, {
            enumerable: true,
            configurable: true,
            get() {
              console.log(`获取${value}`)
              return value
            },
            set(newValue) {
              console.log(`更新${newValue}`)
              if (value !== newValue) {
                value = newValue
                console.log(binding)
                binding._directives.forEach(item => item.update())
              }
            }
          })
        }
      }
    }

    MyVue.prototype._complie = function (root) {
      let _this = this
      let nodes = root.children
      for (let i = 0, len = nodes.length; i < len; i ++) {
        let node = nodes[i]
        if (node.children.length) {
          this._complie(node)
        }
        if (node.hasAttribute("v-click")) {
          node.onclick = (function () {
            let attrVal = nodes[i].getAttribute('v-click')
            return _this.$methods[attrVal].bind(_this.$data) 
          })()
        }
        if (node.hasAttribute("v-model") && (node.tagName === 'INPUT' || node.tagName === 'TEXTAREA')) {
          node.addEventListener('input', (function (key) {
            let attrVal = node.getAttribute('v-model')
            _this._binding[attrVal]._directives.push(new Watcher("input", node, _this, attrVal, "value"))
            return function () {
              _this.$data[attrVal] = nodes[key].value
            }
          })(i))
        }
        if (node.hasAttribute('v-bind')) {
          let attrVal = node.getAttribute('v-bind')
          _this._binding[attrVal]._directives.push(new Watcher(
            "text",
            node,
            _this,
            attrVal,
            "innerHTML"
          ))
        }
      }

    }


    // 指令类Watcher，用来绑定更新函数，实现对DOM元素的更新
    function Watcher(name, el, vm, exp, attr) {
      this.name = name
      this.el = el
      this.vm = vm
      this.exp = exp
      this.attr = attr

      this.update()
    }
    Watcher.prototype.update = function () {
      this.el[this.attr] = this.vm.$data[this.exp]
    }

    let app = new MyVue({
      el: "#app",
      data: {
        number: 0
      },
      methods: {
        increment: function () {
          this.number ++
        }
      }
    })
  </script>
</body>
</html>
