<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>ajax-upload</title>
  </head>
  <body>
    <input id="file" type="file" multiple />
    <script>
      // 1. xhr.onprogress和xhr.upload.onprogress的区别：这两个都能显示进度百分比，
      // 但是，前者显示的是服务器返回的数据，后者是发送给服务器的。
      // 例如，我们ajax get一张图片，则前者合适；如果我们是ajax post上传一张图片，则后者合适。
      var xhr = new XMLHttpRequest();

      xhr.upload.onprogress = () => {};
      xhr.onload = () => {};
      xhr.onerror = () => {};

      xhr.open("POST", "/upload", true); // 默认为 true
      xhr.send(file);

      // 2.
      var files = [...files].filter(item => item.size <= 1024 * 1024);

      // 3.
      const promise = function(file) {
        return new Promise(function(resolve, reject) {
          var xhr = new XMLHttpRequest();
          xhr.onloadend = function() {
            //console.log('complete');
            resolve();
          };
          xhr.onerror = function() {
            //fail
            reject();
          };
          xhr.open("POST", "/upload", true);
          xhr.send(file);
        });
      };

      const promises = [...files].map(function(file) {
        return promise(file);
      });

      // allSettled
      Promise.allSettled(promises).then(function(values) {
        //console.log('all complete');
      });

      // other

      var count = 0;
      // 对获取到的每个文件进行上传
      // 监听上传成功或失败
      xhr.onload = function() {
        count++;
        isFinished(count);
      };
      xhr.onerror = function() {
        count++;
        isFinished(count);
      };
      function isFinished(count) {
        if (count === files.length) {
          // 所有的请求已经结束
        }
      }
    </script>
  </body>
</html>
